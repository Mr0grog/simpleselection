/*
 * SimpleSelection 0.5.2
 *
 * Copyright (c) 2009 Involution Studios (http://involutionstudios.com/)
 * Licensed under the MIT (MIT-LICENSE.txt) license.
 *
 */
var SimpleRange=function(){return this.init.apply(this,arguments)};SimpleRange.prototype={constructor:SimpleRange,_nativeRange:null,_rangeType:"DOM",_stateCache:null,init:function(a){if(!a){return SimpleRange.createDefaultRange()}this._nativeRange=a;if(a.cloneContents){this._rangeType="DOM"}else{if(a.item){this._rangeType="IEControlRange"}else{this._rangeType="IETextRange"}}},getText:function(){if(this._rangeType==="DOM"){return this._nativeRange.toString()}else{return this._nativeRange.text}},getHTML:function(){if(this._rangeType==="DOM"){var b=this._nativeRange.cloneContents();var c=document.createElement("div");c.appendChild(b);var a=c.innerHTML;return a}else{return this._nativeRange.htmlText}},cloneContents:function(){if(this._rangeType==="DOM"){return this._nativeRange.cloneContents()}else{var b=document.createDocumentFragment();var c=document.createElement("div");c.innerHTML=this._nativeRange.htmlText;var a=c.childNodes;while(a.length){b.appendChild(a[0])}return b}},isCollapsed:function(){if(this._rangeType==="DOM"){return this._nativeRange.collapsed}else{return this._nativeRange.compareEndPoints("StartToEnd",this._nativeRange)===0}},getContainingNode:function(){var a=this._nativeRange;if(!a){return null}try{return a.commonAncestorContainer||a.parentElement()}catch(b){return a.item(0).parentNode}},isIn:function(a){var b=this.getContainingNode();while(b){if(b===a){return true}b=b.parentNode}return false},isElement:function(e,g){if(e==null){e=true}var f=this._nativeRange;if(!f){return false}if(this._rangeType==="IEControlRange"){return f.item(0)}else{if(this._rangeType==="IETextRange"){var c=f.parentElement();var h=SimpleRange.createNativeRange(c);if(f.compareEndPoints("StartToStart",h)===0&&f.compareEndPoints("EndToEnd",h)===0){return c}else{return false}}else{if(f.startContainer&&!f.collapsed){var b,j;if(f.startContainer===f.endContainer&&(f.startOffset===0&&f.endOffset===f.startContainer.childNodes.length)){b=j=f.startContainer}else{if(f.startContainer.nodeType===1){b=f.startContainer.childNodes[f.startOffset];if(b.nodeType!==1){if(!b.previousSibling){b=b.parentNode}else{b=null}}}else{if(f.startContainer.nodeType===3){if(f.startContainer.length===f.startOffset){var d=f.startContainer;while(d){if(d.nextSibling){if(d.nextSibling.nodeType===1){b=d.nextSibling}break}d=d.parentNode}}else{if(f.startOffset===0&&!f.startContainer.previousSibling){b=f.startContainer.parentNode}}}}if(b){while(b.childNodes[0]&&b.childNodes[0].nodeType===1){b=b.childNodes[0]}}if(f.endContainer.nodeType===1){j=f.endContainer.childNodes[Math.max(0,f.endOffset-1)];if(j.nodeType!==1){if(!j.nextSibling){j=j.parentNode}else{j=null}}}else{if(f.endContainer.nodeType===3){if(f.endOffset===0){var d=f.endContainer;while(d){if(d.previousSibling){if(d.previousSibling.nodeType===1){j=d.previousSibling}break}d=d.parentNode}}else{if(f.endContainer.length===f.endOffset&&!f.endContainer.nextSibling){j=f.endContainer.parentNode}}}}if(j){while(j.childNodes.length>0&&j.lastChild.nodeType===1){j=j.lastChild}}}if(e){if(b&&b.firstChild&&b.firstChild.nodeType===3){f.setStart(b.firstChild,0)}if(j&&j.lastChild&&j.lastChild.nodeType===3){f.setEnd(j.lastChild,j.lastChild.length)}}if(b&&j&&b.nodeType===1&&j.nodeType===1){var k=null,a=b,i=j;while(a){i=j;while(i){if(a===i){k=a;break}else{if(i.parentNode&&i.parentNode.lastChild===i){i=i.parentNode}else{break}}}if(!k&&a.parentNode&&a.parentNode.firstChild===a){a=a.parentNode}else{break}}if(k){if(g){while(k){if(k===g){return true}else{if(k.parentNode&&k.parentNode.firstChild===k&&k.parentNode.lastChild===k){k=k.parentNode}else{break}}}}else{return k}}}return false}}}},collapse:function(a){this._nativeRange.collapse(!!a)},replaceWith:function(c){if(typeof(c)=="string"){c=document.createTextNode(c)}var a=this._nativeRange;var f=this.isCollapsed();if(c.nodeType==11){var e=c.firstChild;var b=c.lastChild}else{var e=c;var b=c}if(this._rangeType==="IETextRange"){a.pasteHTML("<span id='SimpleSelection_replace_placeholder'></span>");var d=document.getElementById("SimpleSelection_replace_placeholder");d.parentNode.replaceChild(c,d);a.setEndPoint("StartToStart",SimpleRange.createNativeRange(e));if(!f){a.setEndPoint("EndToEnd",SimpleRange.createNativeRange(b))}}else{a.deleteContents();a.insertNode(c);this._nativeRange.setEndAfter(b);if(f){this._nativeRange.collapse(false)}}},wrapWith:function(a){if(typeof(a)=="string"){a=document.createElement(a)}var b=this.cloneContents();a.appendChild(b);this.replaceWith(a);return a},equals:function(a){if(a._nativeRange){a=a._nativeRange}return SimpleRange.nativeEquals(this._nativeRange,a)}};SimpleRange.fromNode=function(a,b){return new SimpleRange(SimpleRange.createNativeRange(a,b))};SimpleRange.createNativeRange=function(d,e){var b;if(document.createRange){b=document.createRange();b[e?"selectNodeContents":"selectNode"](d)}else{b=document.body.createTextRange();if(d.nodeType===1){b.moveToElementText(d)}else{var a=document.createElement("a");d.parentNode.insertBefore(a,d);var c=SimpleRange.createNativeRange(a);a.parentNode.removeChild(a);b.setEndPoint("StartToStart",c);b.collapse(true);b.moveEnd("character",d.nodeValue.length)}}return b};SimpleRange.createDefaultRange=function(){var a=SimpleRange.fromNode(document.body);a.collapse(true);return a};SimpleRange.nativeEquals=function(d,c){if(d&&c){if(d.compareEndPoints){try{return d.compareEndPoints("StartToStart",c)===0&&d.compareEndPoints("EndToEnd",c)===0}catch(e){return false}}else{return d.compareBoundaryPoints(Range.START_TO_START,c)===0&&d.compareBoundaryPoints(Range.END_TO_END,c)===0}}return false};var SimpleSelection={eventThrottle:500,_lastListen:0,_selectionListeners:{},_lastListenerId:0,_currentSelection:null,getRange:function(){if(document.selection){return new SimpleRange(document.selection.createRange())}else{var a=window.getSelection();return new SimpleRange(a.rangeCount?a.getRangeAt(0).cloneRange():null)}},collapse:function(b){var a=this.getRange();a.collapse(b);this.select(a)},select:function(a){if(a.nodeName){a=SimpleRange.fromNode(a)}if(a instanceof SimpleRange){a=a._nativeRange}if(a){SimpleSelection.selectNativeRange(a)}},selectInside:function(b){var a=SimpleRange.fromNode(b)._nativeRange;if(a.selectNodeContents){a.selectNodeContents(b)}this.selectNativeRange(a)},selectNativeRange:function(a){if(window.getSelection){var b=window.getSelection();b.removeAllRanges();b.addRange(a.cloneRange())}else{a.select()}this._currentSelection=new SimpleRange(a)},getText:function(){return this.getRange().getText()},getHTML:function(){return this.getRange().getHTML()},cloneContents:function(){return this.getRange().cloneContents()},isCollapsed:function(){return this.getRange().isCollapsed()},equals:function(a){return this.getRange().equals(a)},getContainingNode:function(){return this.getRange().getContainingNode()},isIn:function(a){return this.getRange().isIn(a)},isElement:function(d,c){var b=this.getRange();var a=b.isElement(d,c);if(d||d==null){this.select(b)}return a},wrapWith:function(a){a=this.getRange().wrapWith(a);this.select(a);return a},replaceWith:function(b){var a=this.getRange();b=a.replaceWith(b);this.select(a);return b},_listenToSelections:function(){var a=function(b){SimpleSelection._evtSelection(b)};this.events.add(document.body,"mouseup",a);this.events.add(document,"keyup",a);this.events.add(document,"mouseout",a)},_evtSelection:function(d){var b=(new Date()).getTime();var c=b-this._lastListen;if(c<this.eventThrottle){if(!arguments.callee.timer){arguments.callee.timer=setTimeout(function(){SimpleSelection._evtSelection(d)},(this.eventThrottle-c))}return}arguments.callee.timer=false;this._lastListen=b;if(d.type!=="mouseout"||d.target===document.documentElement){var a=SimpleSelection.getRange();if(!this._currentSelection||!this._currentSelection.equals(a)){this._currentSelection=a;this.fireEvent("selection",a.getContainingNode())}}},addEventListener:function(c,b,d){if(this._lastListenerId===0){this._listenToSelections()}var a=c.selectid;if(!a){a=c.selectid=this._lastListenerId++;this._selectionListeners[a]=[]}this._selectionListeners[a].push(d)},removeEventListener:function(c,b,e){var d=this._selectionListeners[c.selectid];var a=d.indexOf(e);if(a!==-1){d.splice(a,1)}},fireEvent:function(e,g){if(!g){this._currentSelection=this.getRange();g=this._currentSelection.getContainingNode()}var c=true;var b={selection:this._currentSelection,target:g,stopPropagation:function(){c=false}};while(g&&c){var f=this._selectionListeners[g.selectid];if(f){for(var d=0,a=f.length;d<a;d++){f[d](b)}}g=g.parentNode}},events:{add:function(b,a,c){throw"No SimpleSelection.events provider!"},remove:function(c,a,b){throw"No SimpleSelection.events provider!"}}};SimpleSelection.events.add=function(b,a,c){$(b).bind(a,c)};SimpleSelection.events.remove=function(b,a,c){$(b).unbind(a,c)};